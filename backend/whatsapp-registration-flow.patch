From f2e432e890c449bd92e30ff4360d48b12b482faf Mon Sep 17 00:00:00 2001
From: Techdee02 <akeemjr001@gmail.com>
Date: Wed, 17 Dec 2025 20:04:06 +0000
Subject: [PATCH] feat: Implement two-step WhatsApp patient registration flow
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

- Add registration_status field to Patient entity (PENDING_CLINIC, AWAITING_NAME, COMPLETE)
- Create PatientRegistrationService for handling registration states
- Update WhatsAppService to support clinic selection + name collection
- Add ASK_NAME message constant to BotMessages
- Implement database-only approach (no Redis required)

Registration Flow:
1. New patient â†’ Send clinic options (1, 2, 3)
2. Patient selects clinic â†’ Ask for full name
3. Patient provides name â†’ Parse and complete registration
4. Patient can now send medical queries â†’ Process with AI

Changes include:
- Patient.java: Add registrationStatus column
- PatientRegistrationService.java: New service with setClinicSelection() and completeRegistrationWithName()
- WhatsAppService.java: Three-step state machine (PENDING_CLINIC â†’ AWAITING_NAME â†’ COMPLETE)
- BotMessages.java: Add ASK_NAME message
- REGISTRATION_FLOW.md: Complete documentation with flow diagrams

This implements the WhatsApp bot registration as documented in WHATSAPP_BOT_IMPLEMENTATION.md
---
 REGISTRATION_FLOW.md                          | 232 ++++++++++++++++++
 .../java/com/medassist/dto/BotMessages.java   |   6 +
 .../java/com/medassist/entity/Patient.java    |   6 +
 .../service/PatientRegistrationService.java   | 129 ++++++++++
 .../medassist/service/WhatsAppService.java    | 137 ++++++++---
 5 files changed, 472 insertions(+), 38 deletions(-)
 create mode 100644 REGISTRATION_FLOW.md
 create mode 100644 src/main/java/com/medassist/service/PatientRegistrationService.java

diff --git a/REGISTRATION_FLOW.md b/REGISTRATION_FLOW.md
new file mode 100644
index 0000000..06d62fc
--- /dev/null
+++ b/REGISTRATION_FLOW.md
@@ -0,0 +1,232 @@
+# Patient Registration Flow (Two-Step)
+
+## Complete Flow Diagram
+
+```
+â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+â”‚ STEP 1: New Patient Sends First Message                            â”‚
+â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
+â”‚ Patient: "Hello"                                                    â”‚
+â”‚ Phone: whatsapp:+2348012345678                                     â”‚
+â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+                            â†“
+â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+â”‚ STEP 2: Backend Creates Patient Record (Status: PENDING_CLINIC)    â”‚
+â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
+â”‚ Patient patient = registrationService.startRegistration(phone);    â”‚
+â”‚                                                                     â”‚
+â”‚ Patient Record Created:                                            â”‚
+â”‚   - phone: "+2348012345678"                                        â”‚
+â”‚   - clinic: City Health Clinic (temporary)                         â”‚
+â”‚   - firstName: "Pending"                                           â”‚
+â”‚   - lastName: "Registration"                                       â”‚
+â”‚   - registrationStatus: "PENDING_CLINIC"  â† KEY                    â”‚
+â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+                            â†“
+â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+â”‚ STEP 3: Bot Sends Clinic Options                                   â”‚
+â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
+â”‚ Bot: "ğŸ‘‹ Welcome to MedAssist!                                     â”‚
+â”‚                                                                     â”‚
+â”‚       Which clinic are you registering with?                       â”‚
+â”‚                                                                     â”‚
+â”‚       1ï¸âƒ£ City Health Clinic                                       â”‚
+â”‚       2ï¸âƒ£ Green Cross Pharmacy                                     â”‚
+â”‚       3ï¸âƒ£ Life Care Hospital                                       â”‚
+â”‚                                                                     â”‚
+â”‚       Reply with the number (1, 2, or 3)"                          â”‚
+â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+                            â†“
+â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+â”‚ STEP 4: Patient Selects Clinic                                     â”‚
+â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
+â”‚ Patient: "2"                                                        â”‚
+â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+                            â†“
+â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+â”‚ STEP 5: Backend Updates Patient (Status: AWAITING_NAME)            â”‚
+â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
+â”‚ // Check: registrationStatus == "PENDING_CLINIC" âœ…                â”‚
+â”‚                                                                     â”‚
+â”‚ Patient updated = registrationService.setClinicSelection(          â”‚
+â”‚     patient, "2");                                                 â”‚
+â”‚                                                                     â”‚
+â”‚ Patient Record Updated:                                            â”‚
+â”‚   - clinic: Green Cross Pharmacy  â† UPDATED                        â”‚
+â”‚   - registrationStatus: "AWAITING_NAME"  â† UPDATED                 â”‚
+â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+                            â†“
+â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+â”‚ STEP 6: Bot Asks for Name                                          â”‚
+â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
+â”‚ Bot: "Great! ğŸ‘                                                    â”‚
+â”‚                                                                     â”‚
+â”‚       What's your full name?                                       â”‚
+â”‚                                                                     â”‚
+â”‚       (Example: John Doe)"                                         â”‚
+â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+                            â†“
+â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+â”‚ STEP 7: Patient Provides Name                                      â”‚
+â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
+â”‚ Patient: "Sarah Johnson"                                           â”‚
+â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+                            â†“
+â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+â”‚ STEP 8: Backend Completes Registration (Status: COMPLETE)          â”‚
+â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
+â”‚ // Check: registrationStatus == "AWAITING_NAME" âœ…                 â”‚
+â”‚                                                                     â”‚
+â”‚ Patient completed = registrationService.completeRegistrationWithName(â”‚
+â”‚     patient, "Sarah Johnson");                                     â”‚
+â”‚                                                                     â”‚
+â”‚ Name Parsing:                                                      â”‚
+â”‚   - Split on whitespace: ["Sarah", "Johnson"]                     â”‚
+â”‚   - firstName = "Sarah"                                            â”‚
+â”‚   - lastName = "Johnson"                                           â”‚
+â”‚                                                                     â”‚
+â”‚ Patient Record Final:                                              â”‚
+â”‚   - phone: "+2348012345678"                                        â”‚
+â”‚   - clinic: Green Cross Pharmacy                                   â”‚
+â”‚   - firstName: "Sarah"  â† UPDATED                                  â”‚
+â”‚   - lastName: "Johnson"  â† UPDATED                                 â”‚
+â”‚   - registrationStatus: "COMPLETE"  â† UPDATED                      â”‚
+â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+                            â†“
+â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+â”‚ STEP 9: Bot Sends Confirmation                                     â”‚
+â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
+â”‚ Bot: "âœ… Registration complete!                                    â”‚
+â”‚                                                                     â”‚
+â”‚       You're now connected to Green Cross Pharmacy.                â”‚
+â”‚                                                                     â”‚
+â”‚       How can we help you today?"                                  â”‚
+â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+                            â†“
+â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+â”‚ STEP 10: Patient Sends Medical Query                               â”‚
+â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
+â”‚ Patient: "I have severe headache and fever"                        â”‚
+â”‚                                                                     â”‚
+â”‚ Backend checks:                                                     â”‚
+â”‚   - Patient exists? YES âœ…                                         â”‚
+â”‚   - registrationStatus == "COMPLETE"? YES âœ…                       â”‚
+â”‚                                                                     â”‚
+â”‚ â†’ Route to AI service for symptom analysis                         â”‚
+â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+```
+
+## Registration States
+
+| State | Description | Next State |
+|-------|-------------|------------|
+| `PENDING_CLINIC` | Patient created, awaiting clinic selection | `AWAITING_NAME` |
+| `AWAITING_NAME` | Clinic selected, awaiting patient name | `COMPLETE` |
+| `COMPLETE` | Registration complete, ready for medical queries | N/A |
+
+## Code Decision Logic
+
+```java
+// In WhatsAppService.handleIncomingMessage()
+
+Patient patient = registrationService.findByPhone(normalizedPhone);
+
+if (patient == null) {
+    // NEW PATIENT
+    registrationService.startRegistration(phone);
+    twilioService.sendMessage(phone, BotMessages.WELCOME_MESSAGE);
+    return;
+}
+
+if ("PENDING_CLINIC".equals(patient.getRegistrationStatus())) {
+    // STEP 1: CLINIC SELECTION
+    registrationService.setClinicSelection(patient, messageBody);
+    twilioService.sendMessage(phone, BotMessages.ASK_NAME);
+    return;
+}
+
+if ("AWAITING_NAME".equals(patient.getRegistrationStatus())) {
+    // STEP 2: NAME COLLECTION
+    registrationService.completeRegistrationWithName(patient, messageBody);
+    twilioService.sendMessage(phone, BotMessages.REGISTRATION_COMPLETE);
+    return;
+}
+
+if ("COMPLETE".equals(patient.getRegistrationStatus())) {
+    // FULLY REGISTERED - PROCESS WITH AI
+    processMessageWithAI(patient, messageBody);
+}
+```
+
+## Name Parsing Logic
+
+```java
+// Simple split on whitespace
+String[] nameParts = fullName.trim().split("\\s+", 2);
+
+// Examples:
+"Sarah Johnson"        â†’ firstName="Sarah",    lastName="Johnson"
+"John"                 â†’ firstName="John",     lastName=""
+"Mary Jane Smith"     â†’ firstName="Mary",     lastName="Jane Smith"
+"JosÃ© MarÃ­a GarcÃ­a"   â†’ firstName="JosÃ©",     lastName="MarÃ­a GarcÃ­a"
+```
+
+## Error Handling
+
+**Invalid Clinic Selection:**
+```
+Patient: "5"  (not 1, 2, or 3)
+Bot: "âŒ Invalid selection. Please reply with 1, 2, or 3 to select your clinic."
+```
+
+**Empty Name:**
+```
+Patient: "  "  (whitespace only)
+â†’ firstName="", lastName=""  (allowed, admin can update later)
+```
+
+## Database Schema
+
+```sql
+CREATE TABLE patients (
+    id BINARY(16) PRIMARY KEY,
+    phone VARCHAR(20) UNIQUE NOT NULL,
+    clinic_id BINARY(16) NOT NULL,
+    first_name VARCHAR(100),
+    last_name VARCHAR(100),
+    registration_status VARCHAR(20) DEFAULT 'COMPLETE',
+    registered_at TIMESTAMP NOT NULL,
+    INDEX idx_phone (phone),
+    INDEX idx_clinic_id (clinic_id),
+    INDEX idx_registration_status (registration_status)
+);
+```
+
+## Benefits of This Approach
+
+âœ… **User-friendly:** Natural conversation flow  
+âœ… **Accurate data:** Real patient names instead of placeholders  
+âœ… **Simple:** Only 2 extra messages  
+âœ… **Database-only:** No Redis required  
+âœ… **Flexible:** Easy to add more steps (email, age, etc.) later  
+âœ… **Recoverable:** If patient abandons, record stays pending (can be cleaned up later)  
+
+## Optional Enhancement: Timeout Cleanup
+
+Add a scheduled job to clean up abandoned registrations:
+
+```java
+@Scheduled(cron = "0 0 2 * * ?")  // Daily at 2 AM
+public void cleanupAbandonedRegistrations() {
+    LocalDateTime oneDayAgo = LocalDateTime.now().minusDays(1);
+    
+    List<Patient> abandoned = patientRepository.findByRegistrationStatusIn(
+        List.of("PENDING_CLINIC", "AWAITING_NAME")
+    ).stream()
+    .filter(p -> p.getRegisteredAt().isBefore(oneDayAgo))
+    .collect(Collectors.toList());
+    
+    patientRepository.deleteAll(abandoned);
+    log.info("Cleaned up {} abandoned registrations", abandoned.size());
+}
+```
diff --git a/src/main/java/com/medassist/dto/BotMessages.java b/src/main/java/com/medassist/dto/BotMessages.java
index 3f1a10e..5ac1b0d 100644
--- a/src/main/java/com/medassist/dto/BotMessages.java
+++ b/src/main/java/com/medassist/dto/BotMessages.java
@@ -22,6 +22,12 @@ public class BotMessages {
             "âŒ Invalid selection.\n\n" +
                     "Please reply with 1, 2, or 3 to select your clinic.";
 
+    // Ask for patient name
+    public static final String ASK_NAME =
+            "Great! ğŸ‘\n\n" +
+                    "What's your full name?\n\n" +
+                    "(Example: John Doe)";
+
     // Emergency detected
     public static final String EMERGENCY_ALERT =
             "ğŸš¨ EMERGENCY DETECTED\n\n" +
diff --git a/src/main/java/com/medassist/entity/Patient.java b/src/main/java/com/medassist/entity/Patient.java
index c3372ae..2a66ffc 100644
--- a/src/main/java/com/medassist/entity/Patient.java
+++ b/src/main/java/com/medassist/entity/Patient.java
@@ -37,11 +37,17 @@ public class Patient {
     @Column(name = "last_name", length = 100)
     private String lastName;
 
+    @Column(name = "registration_status", length = 20)
+    private String registrationStatus; // "PENDING_CLINIC" or "COMPLETE"
+
     @Column(name = "registered_at", nullable = false, updatable = false)
     private LocalDateTime registeredAt;
 
     @PrePersist
     protected void onCreate() {
         registeredAt = LocalDateTime.now();
+        if (registrationStatus == null) {
+            registrationStatus = "COMPLETE";
+        }
     }
 }
diff --git a/src/main/java/com/medassist/service/PatientRegistrationService.java b/src/main/java/com/medassist/service/PatientRegistrationService.java
new file mode 100644
index 0000000..11b347f
--- /dev/null
+++ b/src/main/java/com/medassist/service/PatientRegistrationService.java
@@ -0,0 +1,129 @@
+package com.medassist.service;
+
+import com.medassist.entity.Clinic;
+import com.medassist.entity.Patient;
+import com.medassist.repository.ClinicRepository;
+import com.medassist.repository.PatientRepository;
+import lombok.RequiredArgsConstructor;
+import lombok.extern.slf4j.Slf4j;
+import org.springframework.stereotype.Service;
+import org.springframework.transaction.annotation.Transactional;
+
+import java.util.Map;
+import java.util.UUID;
+
+/**
+ * Service for handling patient registration via WhatsApp
+ * Uses database to track pending registrations (no Redis required)
+ */
+@Service
+@RequiredArgsConstructor
+@Slf4j
+public class PatientRegistrationService {
+    
+    private final PatientRepository patientRepository;
+    private final ClinicRepository clinicRepository;
+    
+    // Clinic mapping - maps user's selection (1, 2, 3) to clinic UUIDs
+    private static final Map<String, String> CLINIC_OPTIONS = Map.of(
+        "1", "00000000-0000-0000-0000-000000000001",  // City Health Clinic
+        "2", "00000000-0000-0000-0000-000000000002",  // Green Cross Pharmacy
+        "3", "00000000-0000-0000-0000-000000000003"   // Life Care Hospital
+    );
+    
+    /**
+     * Find patient by phone number
+     */
+    public Patient findByPhone(String phone) {
+        return patientRepository.findByPhone(phone).orElse(null);
+    }
+    
+    /**
+     * Check if patient is in any pending registration state
+     */
+    public boolean isPendingRegistration(Patient patient) {
+        if (patient == null) return false;
+        String status = patient.getRegistrationStatus();
+        return "PENDING_CLINIC".equals(status) || "AWAITING_NAME".equals(status);
+    }
+    
+    /**
+     * Start registration process - create patient record with pending status
+     */
+    @Transactional
+    public Patient startRegistration(String phone) {
+        log.info("Starting registration for phone: {}", phone);
+        
+        // Create patient with pending status and temporary clinic
+        Clinic defaultClinic = clinicRepository.findById(
+                UUID.fromString("00000000-0000-0000-0000-000000000001"))
+            .orElseThrow(() -> new RuntimeException("Default clinic not found"));
+        
+        Patient patient = Patient.builder()
+            .phone(phone)
+            .clinic(defaultClinic)  // Temporary - will be updated
+            .firstName("Pending")
+            .lastName("Registration")
+            .registrationStatus("PENDING_CLINIC")
+            .build();
+        
+        return patientRepository.save(patient);
+    }
+    
+    /**
+     * Process clinic selection and move to name collection step
+     */
+    @Transactional
+    public Patient setClinicSelection(Patient patient, String clinicSelection) {
+        log.info("Setting clinic selection for patient {} with selection: {}", 
+                 patient.getId(), clinicSelection);
+        
+        // Validate selection
+        String clinicId = CLINIC_OPTIONS.get(clinicSelection);
+        if (clinicId == null) {
+            log.warn("Invalid clinic selection: {}", clinicSelection);
+            return null;
+        }
+        
+        // Get selected clinic
+        Clinic clinic = clinicRepository.findById(UUID.fromString(clinicId))
+            .orElseThrow(() -> new RuntimeException("Clinic not found: " + clinicId));
+        
+        // Update patient with clinic and change status to awaiting name
+        patient.setClinic(clinic);
+        patient.setRegistrationStatus("AWAITING_NAME");
+        
+        return patientRepository.save(patient);
+    }
+    
+    /**
+     * Complete registration with patient name
+     */
+    @Transactional
+    public Patient completRegistrationWithName(Patient patient, String fullName) {
+        log.info("Completing registration for patient {} with name: {}", 
+                 patient.getId(), fullName);
+        
+        // Parse name (simple split on space)
+        String[] nameParts = fullName.trim().split("\\s+", 2);
+        String firstName = nameParts[0];
+        String lastName = nameParts.length > 1 ? nameParts[1] : "";
+        
+        // Update patient
+        patient.setFirstName(firstName);
+        patient.setLastName(lastName);
+        patient.setRegistrationStatus("COMPLETE");
+        
+        return patientRepository.save(patient);
+    }
+    
+    /**
+     * Cleanup stale pending registrations (can be run periodically)
+     */
+    @Transactional
+    public void cleanupStalePendingRegistrations() {
+        // Optional: Delete pending registrations older than 1 hour
+        // This prevents database pollution from abandoned registrations
+        log.info("Cleanup of stale pending registrations (not implemented yet)");
+    }
+}
diff --git a/src/main/java/com/medassist/service/WhatsAppService.java b/src/main/java/com/medassist/service/WhatsAppService.java
index 4173235..f3063b0 100644
--- a/src/main/java/com/medassist/service/WhatsAppService.java
+++ b/src/main/java/com/medassist/service/WhatsAppService.java
@@ -24,6 +24,9 @@ public class WhatsAppService {
     @Autowired
     private PatientService patientService;
 
+    @Autowired
+    private PatientRegistrationService registrationService;
+
     @Autowired
     private AIServiceClient aiServiceClient;
 
@@ -39,51 +42,109 @@ public class WhatsAppService {
 
         String normalizedPhone = normalizePhone(fromPhone);
 
-        Patient patient = patientService.createOrGetPatient(normalizedPhone, getDefaultClinicId());
+        // Step 1: Check if patient exists
+        Patient patient = registrationService.findByPhone(normalizedPhone);
 
-        if(patient == null) {
+        if (patient == null) {
+            // New patient - start registration process
+            logger.info("New patient detected: {}", normalizedPhone);
+            registrationService.startRegistration(normalizedPhone);
             twilioService.sendMessage(normalizedPhone, BotMessages.WELCOME_MESSAGE);
+            return;
         }
-        else {
-
-            Conversation conversation = getOrCreateConversation(patient);
-
-            Message userMessage = Message.builder()
-                    .conversation(conversation)
-                    .role(MessageRole.USER)
-                    .content(messageBody)
-                    .build();
-            conversation.addMessage(userMessage);
-            conversationRepository.save(conversation);
-
-            AIServiceRequest aiRequest = AIServiceRequest.builder()
-                    .messageId(UUID.randomUUID().toString())
-                    .patientId(patient.getId().toString())
-                    .sessionId(conversation.getSessionId())
-                    .message(messageBody)
-                    .build();
-
-            AIServiceResponse aiResponse = aiServiceClient.processMessage(aiRequest);
-
-            Message assistantMessage = Message.builder()
-                    .conversation(conversation)
-                    .role(MessageRole.ASSISTANT)
-                    .content(aiResponse.getResponse())
-                    .triageLevel(aiResponse.getTriageLevel())
-                    .build();
-            conversation.addMessage(assistantMessage);
-
-            if (aiResponse.getTriageLevel() != null) {
-                conversation.setTriageLevel(aiResponse.getTriageLevel());
+
+        // Step 2: Check if patient is pending clinic selection
+        if ("PENDING_CLINIC".equals(patient.getRegistrationStatus())) {
+            logger.info("Patient {} is selecting clinic", normalizedPhone);
+            
+            // Validate selection (must be 1, 2, or 3)
+            if (!messageBody.trim().matches("[123]")) {
+                twilioService.sendMessage(normalizedPhone, BotMessages.INVALID_CLINIC);
+                return;
             }
+            
+            // Set clinic and move to name collection
+            Patient updatedPatient = registrationService.setClinicSelection(patient, messageBody.trim());
+            
+            if (updatedPatient == null) {
+                twilioService.sendMessage(normalizedPhone, BotMessages.INVALID_CLINIC);
+                return;
+            }
+            
+            // Ask for name
+            twilioService.sendMessage(normalizedPhone, BotMessages.ASK_NAME);
+            logger.info("Asked patient {} for name", updatedPatient.getId());
+            return;
+        }
+        
+        // Step 3: Check if patient is providing their name
+        if ("AWAITING_NAME".equals(patient.getRegistrationStatus())) {
+            logger.info("Patient {} is providing name", normalizedPhone);
+            
+            // Complete registration with name
+            Patient completedPatient = registrationService.completRegistrationWithName(patient, messageBody.trim());
+            
+            // Send confirmation
+            String confirmationMessage = String.format(
+                BotMessages.REGISTRATION_COMPLETE,
+                completedPatient.getClinic().getName()
+            );
+            twilioService.sendMessage(normalizedPhone, confirmationMessage);
+            
+            logger.info("Registration completed for patient {} ({} {}) - Clinic: {}", 
+                       completedPatient.getId(),
+                       completedPatient.getFirstName(),
+                       completedPatient.getLastName(),
+                       completedPatient.getClinic().getName());
+            return;
+        }
 
-            conversationRepository.save(conversation);
+        // Step 4: Regular message processing for fully registered patients
+        if (!"COMPLETE".equals(patient.getRegistrationStatus())) {
+            // Safety check - shouldn't reach here, but handle gracefully
+            logger.warn("Patient {} in unexpected registration status: {}", 
+                       patient.getId(), patient.getRegistrationStatus());
+            twilioService.sendMessage(normalizedPhone, BotMessages.ERROR_MESSAGE);
+            return;
+        }
+        
+        Conversation conversation = getOrCreateConversation(patient);
+
+        Message userMessage = Message.builder()
+                .conversation(conversation)
+                .role(MessageRole.USER)
+                .content(messageBody)
+                .build();
+        conversation.addMessage(userMessage);
+        conversationRepository.save(conversation);
+
+        AIServiceRequest aiRequest = AIServiceRequest.builder()
+                .messageId(UUID.randomUUID().toString())
+                .patientId(patient.getId().toString())
+                .sessionId(conversation.getSessionId())
+                .message(messageBody)
+                .build();
+
+        AIServiceResponse aiResponse = aiServiceClient.processMessage(aiRequest);
+
+        Message assistantMessage = Message.builder()
+                .conversation(conversation)
+                .role(MessageRole.ASSISTANT)
+                .content(aiResponse.getResponse())
+                .triageLevel(aiResponse.getTriageLevel())
+                .build();
+        conversation.addMessage(assistantMessage);
+
+        if (aiResponse.getTriageLevel() != null) {
+            conversation.setTriageLevel(aiResponse.getTriageLevel());
+        }
 
-            twilioService.sendMessage(normalizedPhone, aiResponse.getResponse());
+        conversationRepository.save(conversation);
 
-            logger.info("Processed message for patient {} - Triage: {}",
-                    patient.getId(), aiResponse.getTriageLevel());
-        }
+        twilioService.sendMessage(normalizedPhone, aiResponse.getResponse());
+
+        logger.info("Processed message for patient {} - Triage: {}",
+                patient.getId(), aiResponse.getTriageLevel());
     }
 
     private String normalizePhone(String phone) {
-- 
2.52.0

